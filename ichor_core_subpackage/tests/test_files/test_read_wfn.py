from pathlib import Path
from typing import List

import numpy as np

import pytest

from ichor.core.atoms import Atom, Atoms
from ichor.core.common.units import AtomicDistance
from ichor.core.files import WFN
from ichor.core.files.gaussian.wfn import MolecularOrbital

from tests.path import get_cwd
from tests.test_atoms import _test_atoms_coords
from tests.test_files import _assert_val_optional

example_dir = (
    get_cwd(__file__)
    / ".."
    / ".."
    / ".."
    / "example_files"
    / "example_points_directory"
    / "WATER_MONOMER.pointsdir"
    / "WATER_MONOMER0000.pointdir"
)


def _test_molecular_orbitals(
    wfn_file_molecular_orbitals: List[MolecularOrbital],
    reference_molecular_orbitals: List[MolecularOrbital],
):

    """Asserts that a MolecularOrbital instance is equal to a reference MolecularOrbital instance"""

    for mo, ref_mo in zip(wfn_file_molecular_orbitals, reference_molecular_orbitals):
        assert mo.index == ref_mo.index
        assert mo.occupation_number == pytest.approx(ref_mo.occupation_number)
        assert mo.energy == pytest.approx(ref_mo.energy)
        assert mo.primitives == ref_mo.primitives


def _test_read_wfn(
    wfn_file: Path,
    method: str = None,
    atoms: Atoms = None,
    n_orbitals: int = None,
    n_primitives: int = None,
    n_nuclei: int = None,
    centre_assignments: List[int] = None,
    type_assignments: List[int] = None,
    primitive_exponents: np.ndarray = None,
    molecular_orbitals: List[MolecularOrbital] = None,
    total_energy: float = None,
    virial_ratio: float = None,
):

    wfn_file = WFN(wfn_file)

    _assert_val_optional(wfn_file.method, method)
    _test_atoms_coords(wfn_file.atoms, atoms, AtomicDistance.Bohr)
    _assert_val_optional(wfn_file.n_orbitals, n_orbitals)
    _assert_val_optional(wfn_file.n_primitives, n_primitives)
    _assert_val_optional(wfn_file.n_nuclei, n_nuclei)
    _assert_val_optional(wfn_file.centre_assignments, centre_assignments)
    _assert_val_optional(wfn_file.type_assignments, type_assignments)
    _assert_val_optional(wfn_file.primitive_exponents, primitive_exponents)
    _test_molecular_orbitals(wfn_file.molecular_orbitals, molecular_orbitals)
    _assert_val_optional(wfn_file.total_energy, total_energy)
    _assert_val_optional(wfn_file.virial_ratio, virial_ratio)


def test_water_monomer_wfn():

    wfn_file_path = example_dir / "WATER_MONOMER0000.wfn"

    expected_atoms = Atoms(
        [
            Atom("O", -0.06328188, -0.88230871, -0.00802954, units=AtomicDistance.Bohr),
            Atom("H", -0.95295536, 0.38291891, 1.07137737, units=AtomicDistance.Bohr),
            Atom("H", 1.01623724, 0.49938980, -1.06334783, units=AtomicDistance.Bohr),
        ]
    )

    expected_molecular_orbitals = [
        MolecularOrbital(
            1,
            2.0,
            -19.183769,
            [
                0.82574534,
                1.5198122,
                2.4593431,
                3.2328753,
                2.7728184,
                0.94807369,
                -0.015958993,
                -0.0071208717,
                0.02102803,
                -4.514294e-05,
                -3.4780202e-05,
                -1.5270382e-05,
                0.0036547012,
                0.0028157502,
                0.001236266,
                0.00036794568,
                0.00028348231,
                0.000124464,
                0.0030324682,
                -2.973056e-05,
                -0.00020356245,
                1.4627729e-05,
                -0.00014059895,
                -2.4222374e-07,
                4.3612283e-05,
                4.0678307e-06,
                -0.0089065637,
                -0.0089817438,
                -0.0089043834,
                -0.00017082454,
                0.00013642586,
                0.00016083274,
                7.6618015e-05,
                0.00012995865,
                0.00014795333,
                -0.00015195251,
                -2.512583e-05,
                0.0001140878,
                3.731867e-05,
                9.3445641e-05,
                0.00015850149,
                0.00018044835,
                -9.2768184e-05,
                -0.00021035191,
                -0.00020791465,
                0.00021098466,
            ],
        ),
        MolecularOrbital(
            2,
            2.0,
            -1.000442,
            [
                -0.17618036,
                -0.32426591,
                -0.52472346,
                -0.68976367,
                -0.59160629,
                -0.20228024,
                -0.2960371,
                -0.13209118,
                0.39006702,
                -0.016222879,
                -0.012498853,
                -0.0054876698,
                0.35832627,
                0.27607107,
                0.12121007,
                0.048924496,
                0.037693687,
                0.016549559,
                0.11834214,
                0.00024102961,
                0.013484455,
                0.00091361782,
                0.0020345316,
                -0.00010088378,
                0.00061381832,
                0.00016342337,
                -0.0041121661,
                0.0062435065,
                -0.0031885543,
                0.0017708465,
                -0.011220855,
                0.0007885737,
                0.032431542,
                0.055010033,
                0.062626978,
                0.00041797327,
                0.019981247,
                -0.021825816,
                -0.023667683,
                0.025627815,
                0.043469624,
                0.049488631,
                0.001383982,
                -0.01922866,
                -0.017995418,
                0.019374632,
            ],
        ),
        MolecularOrbital(
            3,
            2.0,
            -0.497418,
            [
                0.0083032765,
                0.015282461,
                0.024729907,
                0.032508155,
                0.027882056,
                0.0095333484,
                0.013688341,
                0.0061077112,
                -0.018036153,
                -1.0919028,
                -0.84125222,
                -0.36935504,
                0.088334537,
                0.068056999,
                0.029880688,
                1.1970272,
                0.9222449,
                0.40491518,
                -0.011671171,
                -0.050028543,
                0.0022601975,
                0.054689233,
                -0.00080781372,
                -0.00085119488,
                0.00019202201,
                0.00094388808,
                -0.001438274,
                0.0007339322,
                0.0020219979,
                -0.038749381,
                -0.00071155326,
                0.042371866,
                0.051368523,
                0.087130738,
                0.099195266,
                0.027815876,
                0.0038711078,
                -0.025042354,
                -0.0064007525,
                -0.048149474,
                -0.081670621,
                -0.092979116,
                -0.028209916,
                0.0065947367,
                0.025484585,
                -0.0049602849,
            ],
        ),
        MolecularOrbital(
            4,
            2.0,
            -0.408131,
            [
                0.069882098,
                0.12862037,
                0.20813203,
                0.27359538,
                0.23466117,
                0.080234639,
                0.11786831,
                0.052592611,
                -0.15530668,
                0.11513509,
                0.088705382,
                0.038946441,
                1.6792427,
                1.293766,
                0.56803295,
                0.021060871,
                0.016226266,
                0.0071242047,
                -0.088506343,
                0.0063371936,
                0.084224679,
                0.00044371652,
                -0.0068383345,
                0.00023365604,
                0.0040096703,
                9.523125e-05,
                -0.0076332649,
                0.036516655,
                -0.0076291501,
                0.003663801,
                0.00013644394,
                0.0037257387,
                0.032051716,
                0.054365776,
                0.061893514,
                0.021343028,
                0.016301142,
                0.013054171,
                -0.016616907,
                0.036753993,
                0.062341728,
                0.070973854,
                0.026182892,
                -0.016712989,
                0.0072603123,
                0.01883739,
            ],
        ),
        MolecularOrbital(
            5,
            2.0,
            -0.31796,
            [
                -1.9485026e-09,
                -3.586285e-09,
                -5.803286e-09,
                -7.6285819e-09,
                -6.5429904e-09,
                -2.2371595e-09,
                -3.6329517e-09,
                -1.621016e-09,
                4.7868819e-09,
                1.4815198,
                1.1414312,
                0.50114976,
                -0.11863746,
                -0.091403771,
                -0.040131179,
                1.3601657,
                1.0479343,
                0.46009962,
                7.6530291e-10,
                0.085407683,
                -0.0068392992,
                0.078411774,
                -1.0015969e-08,
                0.0061878493,
                -0.00049551512,
                0.0056809916,
                0.00032576215,
                -0.0031134809,
                0.0027877202,
                0.0388544,
                0.0033355193,
                0.035452559,
                3.3213631e-10,
                5.6336605e-10,
                6.4137234e-10,
                1.337752e-08,
                0.025921792,
                -0.0020757728,
                0.023798483,
                -9.6898476e-10,
                -1.6435816e-09,
                -1.8711595e-09,
                4.8171887e-09,
                0.023103777,
                -0.0018501107,
                0.021211305,
            ],
        ),
    ]

    expected_centre_assignments = [
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
    ]
    expected_type_assignments = [
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        2,
        2,
        2,
        3,
        3,
        3,
        4,
        4,
        4,
        1,
        2,
        3,
        4,
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        1,
        1,
        1,
        1,
        2,
        3,
        4,
        1,
        1,
        1,
        1,
        2,
        3,
        4,
    ]
    expected_primitive_exponents = [
        5484.672,
        825.2349,
        188.047,
        52.9645,
        16.89757,
        5.799635,
        15.53962,
        3.599934,
        1.013762,
        15.53962,
        3.599934,
        1.013762,
        15.53962,
        3.599934,
        1.013762,
        15.53962,
        3.599934,
        1.013762,
        0.2700058,
        0.2700058,
        0.2700058,
        0.2700058,
        0.0845,
        0.0845,
        0.0845,
        0.0845,
        0.8,
        0.8,
        0.8,
        0.8,
        0.8,
        0.8,
        18.73114,
        2.825394,
        0.6401217,
        0.1612778,
        1.1,
        1.1,
        1.1,
        18.73114,
        2.825394,
        0.6401217,
        0.1612778,
        1.1,
        1.1,
        1.1,
    ]

    _test_read_wfn(
        wfn_file_path,
        method="B3LYP",
        atoms=expected_atoms,
        n_orbitals=5,
        n_primitives=46,
        n_nuclei=3,
        centre_assignments=expected_centre_assignments,
        type_assignments=expected_type_assignments,
        primitive_exponents=expected_primitive_exponents,
        molecular_orbitals=expected_molecular_orbitals,
        total_energy=-76.421710687455,
        virial_ratio=2.01177209,
    )
